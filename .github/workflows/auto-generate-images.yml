name: ğŸ—ºï¸ VegaVery Map Generator - Auto Schedule

on:
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (UTC ê¸°ì¤€)
  schedule:
    # ë§¤ì¼ ìƒˆë²½ 4ì‹œ (KST) = 19:00 UTC
    - cron: '0 19 * * *'
    # ë§¤ì¼ ì˜¤í›„ 2ì‹œ (KST) = 05:00 UTC  
    - cron: '0 5 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      reason:
        description: 'ì‹¤í–‰ ì´ìœ '
        required: false
        default: 'ìˆ˜ë™ ì‹¤í–‰'

jobs:
  generate-images:
    name: ğŸ–¼ï¸ ì´ë¯¸ì§€ ìë™ ìƒì„±
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ ì›Œí¬í”Œë¡œìš° ì‹œì‘
      run: |
        echo "ğŸ—ºï¸ VegaVery Map Generator ìë™ ì‹¤í–‰ ì‹œì‘"
        echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ“ í•œêµ­ ì‹œê°„: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸ”§ ìˆ˜ë™ ì‹¤í–‰ - ì´ìœ : ${{ github.event.inputs.reason }}"
        else
          echo "â° ìŠ¤ì¼€ì¤„ ì‹¤í–‰"
        fi

    - name: ğŸ“ Vercel API í˜¸ì¶œ
      run: |
        echo "ğŸŒ Vercel ë°°í¬ëœ API ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ ì¤‘..."
        
        # API í˜¸ì¶œ ë° ì‘ë‹µ ì €ì¥
        response=$(curl -s -w "\n%{http_code}" "https://vgvr-map.vercel.app/api/generate-images")
        http_code=$(echo "$response" | tail -n1)
        body=$(echo "$response" | head -n -1)
        
        echo "ğŸ“Š HTTP ìƒíƒœ ì½”ë“œ: $http_code"
        echo "ğŸ“ ì‘ë‹µ ë‚´ìš©:"
        echo "$body"
        
        # ì„±ê³µ ì—¬ë¶€ í™•ì¸
        if [ "$http_code" -eq 200 ]; then
          echo "âœ… ì´ë¯¸ì§€ ìƒì„± ì„±ê³µ!"
          
          # JSON ì‘ë‹µì—ì„œ ìƒì„±ëœ ì´ë¯¸ì§€ ìˆ˜ ì¶”ì¶œ (jqê°€ ì—†ìœ¼ë©´ grep ì‚¬ìš©)
          if command -v jq >/dev/null 2>&1; then
            total=$(echo "$body" | jq -r '.results.totalGenerated // "ì•Œ ìˆ˜ ì—†ìŒ"')
            echo "ğŸ–¼ï¸ ì´ ìƒì„±ëœ ì´ë¯¸ì§€: $totalê°œ"
          else
            echo "ğŸ–¼ï¸ ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ (ìƒì„¸ ì •ë³´ëŠ” ì‘ë‹µ ë‚´ìš© ì°¸ì¡°)"
          fi
          
        else
          echo "âŒ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨ (HTTP $http_code)"
          exit 1
        fi

    - name: ğŸ” ìƒì„±ëœ ì´ë¯¸ì§€ í™•ì¸
      run: |
        echo "ğŸ–¼ï¸ ìƒì„±ëœ PNG ì´ë¯¸ì§€ URL ëª©ë¡:"
        echo "https://vgvr-map.vercel.app/generated-png/ìš©ì¸íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/êµ¬ë•íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ì‹ ì´ŒíŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ì‚¬ì§íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/í•˜ë‚¨íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ì–‘ì‚°íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ìˆ˜ì›íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ë¶€ì²œíŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ì„œë©´íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ë°˜í¬íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ëª©ë™íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ì ì‹¤íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ì˜ì •ë¶€íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/í•´ìš´ëŒ€íŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/ì¸ì²œíŒ€.png"
        echo "https://vgvr-map.vercel.app/generated-png/íŒŒì£¼íŒ€.png"

    - name: ğŸ“Š ì‹¤í–‰ ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "ğŸ‰ VegaVery Map Generator ìë™ ì‹¤í–‰ ì™„ë£Œ!"
        echo "â° ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ“ í•œêµ­ ì‹œê°„: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"
        echo ""
        echo "ğŸ”„ ë‹¤ìŒ ìë™ ì‹¤í–‰ ì˜ˆì •:"
        echo "  â€¢ ë§¤ì¼ ìƒˆë²½ 4ì‹œ (KST)"
        echo "  â€¢ ë§¤ì¼ ì˜¤í›„ 2ì‹œ (KST)"
        echo ""
        echo "ğŸŒ ë©”ì¸ í˜ì´ì§€: https://vgvr-map.vercel.app"
