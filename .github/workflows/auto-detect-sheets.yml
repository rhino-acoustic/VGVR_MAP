name: ğŸ”„ Google Sheets ë³€ê²½ ê°ì§€ ë° ì´ë¯¸ì§€ ìƒì„±

on:
  # ë§¤ì¼ ì˜¤ì „ 4ì‹œ, ì˜¤í›„ 2ì‹œ (KST) ìë™ ì‹¤í–‰
  schedule:
    - cron: '0 19 * * *'  # UTC 19:00 = KST 04:00
    - cron: '0 5 * * *'   # UTC 05:00 = KST 14:00
  
  # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©
  workflow_dispatch:
    inputs:
      force_generation:
        description: 'ê°•ì œë¡œ ì´ë¯¸ì§€ ìƒì„± (ë³€ê²½ì‚¬í•­ ë¬´ì‹œ)'
        required: false
        default: 'false'
        type: boolean

jobs:
  detect-and-generate:
    runs-on: ubuntu-latest
    name: ì‹œíŠ¸ ë³€ê²½ ê°ì§€ ë° ì´ë¯¸ì§€ ìƒì„±
    
    steps:
      - name: ğŸ” ì‹œíŠ¸ ë³€ê²½ ê°ì§€ ì‹œì‘
        run: |
          echo "ğŸ” Google Sheets ë³€ê²½ ê°ì§€ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')"
      
      - name: ğŸ“Š Google Sheets ë°ì´í„° í•´ì‹œ ìƒì„±
        id: sheet-hash
        run: |
          # Google Sheets APIë¥¼ í†µí•´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° í•´ì‹œ ìƒì„±
          SHEET_DATA=$(curl -s "https://sheets.googleapis.com/v4/spreadsheets/${{ secrets.GOOGLE_SHEETS_SPREADSHEET_ID }}/values/A1:Z50?key=${{ secrets.GOOGLE_MAPS_API_KEY }}")
          CURRENT_HASH=$(echo "$SHEET_DATA" | sha256sum | cut -d' ' -f1)
          echo "current_hash=$CURRENT_HASH" >> $GITHUB_OUTPUT
          echo "ğŸ“Š í˜„ì¬ ì‹œíŠ¸ í•´ì‹œ: $CURRENT_HASH"
      
      - name: ğŸ’¾ ì´ì „ í•´ì‹œ ê°€ì ¸ì˜¤ê¸°
        id: previous-hash
        run: |
          # GitHub APIë¥¼ í†µí•´ ì´ì „ í•´ì‹œ ê°€ì ¸ì˜¤ê¸° (Repository Variable ì‚¬ìš©)
          PREVIOUS_HASH=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/variables/LAST_SHEET_HASH" | \
            jq -r '.value // "none"')
          echo "previous_hash=$PREVIOUS_HASH" >> $GITHUB_OUTPUT
          echo "ğŸ’¾ ì´ì „ ì‹œíŠ¸ í•´ì‹œ: $PREVIOUS_HASH"
      
      - name: ğŸ” ë³€ê²½ì‚¬í•­ í™•ì¸
        id: check-changes
        run: |
          CURRENT="${{ steps.sheet-hash.outputs.current_hash }}"
          PREVIOUS="${{ steps.previous-hash.outputs.previous_hash }}"
          FORCE="${{ github.event.inputs.force_generation }}"
          
          if [ "$CURRENT" != "$PREVIOUS" ] || [ "$FORCE" = "true" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… ë³€ê²½ì‚¬í•­ ê°ì§€ë¨ ë˜ëŠ” ê°•ì œ ì‹¤í–‰"
            if [ "$FORCE" = "true" ]; then
              echo "ğŸ”§ ê°•ì œ ì‹¤í–‰ ëª¨ë“œ"
            else
              echo "ğŸ“Š ì‹œíŠ¸ ë°ì´í„° ë³€ê²½ ê°ì§€"
            fi
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì´ë¯¸ì§€ ìƒì„± ê±´ë„ˆëœ€"
          fi
      
      - name: ğŸ–¼ï¸ Vercelì—ì„œ ì´ë¯¸ì§€ ìƒì„± íŠ¸ë¦¬ê±°
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ Vercel APIë¡œ ì´ë¯¸ì§€ ìƒì„±ì„ ìš”ì²­í•©ë‹ˆë‹¤..."
          
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            "https://vgvr-map.vercel.app/api/generate-images")
          
          echo "ğŸ“‹ ì‘ë‹µ: $RESPONSE"
          
          # ì„±ê³µ ì—¬ë¶€ í™•ì¸
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… ì´ë¯¸ì§€ ìƒì„± ì„±ê³µ!"
            FILES=$(echo "$RESPONSE" | jq -r '.files // 0')
            echo "ğŸ“ ìƒì„±ëœ íŒŒì¼ ìˆ˜: $FILES"
          else
            echo "âŒ ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨"
            ERROR=$(echo "$RESPONSE" | jq -r '.error // "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"')
            echo "ì˜¤ë¥˜: $ERROR"
            exit 1
          fi
      
      - name: ğŸ’¾ ìƒˆë¡œìš´ í•´ì‹œ ì €ì¥
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # Repository Variable ì—…ë°ì´íŠ¸
          curl -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/variables/LAST_SHEET_HASH" \
            -d '{"name":"LAST_SHEET_HASH","value":"${{ steps.sheet-hash.outputs.current_hash }}"}'
          
          echo "ğŸ’¾ ìƒˆë¡œìš´ í•´ì‹œ ì €ì¥ ì™„ë£Œ: ${{ steps.sheet-hash.outputs.current_hash }}"
      
      - name: ğŸ“ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ ìë™ ê°ì§€ ì‘ì—… ì™„ë£Œ"
          echo "â° ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ” ë³€ê²½ì‚¬í•­: ${{ steps.check-changes.outputs.has_changes }}"
          if [ "${{ steps.check-changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ"
          else
            echo "â¸ï¸ ë³€ê²½ì‚¬í•­ ì—†ì–´ ìƒì„± ê±´ë„ˆëœ€"
          fi
